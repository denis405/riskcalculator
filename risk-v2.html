<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Risk Calculator v2</title>

<style>
body {
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  background:#0f1115;
  color:#fff;
  margin:0;
  padding:16px;
}

.card {
  background:#181b22;
  border-radius:12px;
  padding:14px;
  margin-bottom:12px;
}

.row { display:flex; gap:8px; }

button, input {
  width:100%;
  padding:10px;
  border-radius:8px;
  border:none;
  background:#232734;
  color:white;
  font-size:14px;
}

button.active { background:#4f7cff; }

.small { font-size:12px; opacity:0.7; }

#settings { display:none; }
</style>
</head>

<body>

<div class="row">
  <h3 style="flex:1">Risk Calculator</h3>
  <button onclick="toggleSettings()" style="width:auto">⚙️</button>
</div>

<div id="settings" class="card">
  <div class="small">Комиссии (доли, не %)</div>
  <input id="spotMaker" value="0.001">
  <input id="spotTaker" value="0.0018">
  <input id="futMaker" value="0.00036">
  <input id="futTaker" value="0.001">
</div>

<div class="card">
  <div class="row">
    <button id="modeSpot" class="active" onclick="setMode('spot')">SPOT</button>
    <button id="modeFutures" onclick="setMode('futures')">FUTURES</button>
  </div>
  <div class="row" style="margin-top:8px">
    <button id="longBtn" class="active" onclick="setSide('long')">LONG</button>
    <button id="shortBtn" onclick="setSide('short')">SHORT</button>
  </div>
</div>

<div class="card">
  <input id="capital" type="number" value="1000" placeholder="Capital USDT">
  <input id="risk" type="number" value="1" step="0.1" placeholder="Risk %">
  <input id="entry" type="number" placeholder="Entry">
  <input id="sl" type="number" placeholder="Stop Loss">
  <input id="tp" type="number" placeholder="Take Profit">
  <input id="symbol" value="BTCUSDT" placeholder="Symbol">
</div>

<div class="card" id="leverageBox" style="display:none">
  <input id="leverage" type="number" value="1" placeholder="Leverage">
  <label class="small">
    <input type="checkbox" id="useFunding" checked> учитывать funding
  </label>
</div>

<div class="card">
  <button onclick="calculate()">Calculate</button>
</div>

<div class="card" id="result"></div>

<script>
let mode = "spot";
let side = "long";

function setMode(m){
  mode=m;
  modeSpot.classList.toggle("active",m==="spot");
  modeFutures.classList.toggle("active",m==="futures");
  leverageBox.style.display = m==="futures"?"block":"none";
}

function setSide(s){
  side=s;
  longBtn.classList.toggle("active",s==="long");
  shortBtn.classList.toggle("active",s==="short");
}

function toggleSettings(){
  settings.style.display = settings.style.display==="none"?"block":"none";
}

async function getFunding(symbol){
  const r = await fetch(`https://api.bybit.com/v5/market/funding/history?category=linear&symbol=${symbol}&limit=1`);
  const j = await r.json();
  return +j.result?.list?.[0]?.fundingRate || 0;
}

async function calculate(){
  const capital = +document.getElementById("capital").value;
  const riskPct = +document.getElementById("risk").value / 100;
  const entry = +document.getElementById("entry").value;
  const sl = +document.getElementById("sl").value;
  const symbol = document.getElementById("symbol").value;
  const lev = +document.getElementById("leverage").value || 1;

  const move = Math.abs(entry - sl);
  if (!move) { result.innerHTML="❌ Invalid SL"; return; }

  const maxLoss = capital * riskPct;

  const maker = +(mode==="spot"?spotMaker.value:futMaker.value);
  const taker = +(mode==="spot"?spotTaker.value:futTaker.value);

  let funding = 0;
  if (mode==="futures" && useFunding.checked){
    funding = entry * (await getFunding(symbol));
  }

  const fees = entry*maker + entry*taker + funding;
  const netRisk = maxLoss - fees;
  if (netRisk<=0){ result.innerHTML="❌ Fees eat all risk"; return; }

  const size = netRisk / move;
  const margin = mode==="spot" ? size*entry : (size*entry)/lev;

  result.innerHTML = `
  Size: <b>${size.toFixed(4)}</b><br>
  Margin: <b>${margin.toFixed(2)} USDT</b><br>
  Fees+funding: ${fees.toFixed(2)} USDT
  `;
}
</script>

</body>
</html>
